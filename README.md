# Lockdown

- TODO(ak): Lockdown description

# Lockdown node example

This is a simple example to demonstrate how to work with a Lockdown enabled node. This code simply takes
command line arguments and outputs even, odd, or NaN for each input. Example:

```console
$ node index.js a 1
The input a is NaN
The input 1 is odd
```

Our example depends on 4 popular npm packages in total which we need to obtain hashes for. Some packages
are dynamically required depending on the input. The code needs at least a single input to
require `is-number`, and the code would require `is-even` only if one of the inputs is indeed a number.

This means that simply running the code in the special hash generation mode is not enough to get all
the hashes of all the .js files the code depends on.

Even though our example only depends on 4 packages, our `node_modules` directory already has 14 different
modules and a total of 34 .js files. Some npm packages come with their test files (e.g. minimist)
which we do not want to include in our TCB.

Generating hashes for all the files that an application depends on while keeping the TCB as small as possible is
challenging and there are different approaches each with their own shortcomings.

One approach, for example, is to write a script that requires each and every .js file our example depends
on and run it in the hash generation mode but this is very challenging as the number of files grows very
quickly with more dependencies. Additionally, if we simply require the modules themselves we could miss
dynamically required dependencies in these modules. This approach, however, is suitable for generating
hashes for the internal node modules such as *fs* or *process*.

Another approach we will explain for this example is to use Webpack with our own custom loader to only
generate the hashes for the files our code depends on without any extra code. We will combine this
approach with the previous approach to get both the internal hashes as well as our code hashes.

## Hash generation

### Internal node modules

- We run node in the hash generation mode with the flag --lockdown-gen-hashes and require all
  the node internal modules (we use `require('module').builtinModules`)

  `$ node --lockdown-gen-hashes modules.js`

  or

  `$ node --lockdown-gen-hashes modules.js`

### Application and node_modules (Webpack)

- We rely on Webpack to resolve all the dependencies and use a custom loader that generates hashes for each
  dependency. A simple Webpack config file for this example code is provided in the repository

- We combine the hashes generated by Webpack with the hashes for the internal node modules in one file and
  run node with this file

- Our example has a total of 35 .js files (index.js and 34 in `node_modules`) but Webpack found
  only 19 .js files that our code needs and generated hashes for them

## Integrity violation
- TODO(ak): example of modifying a file violation
